# 文件上传漏洞

## 漏洞概述

文件上传功能是Web应用得必备功能之一，比如上传头像显示个性化、上传附件共享文件、上传脚本更新网站等。如果服务器配置不当后者没有进行足够的过滤，Web用户就可以上传任意文件，包括恶意脚本文件、exe程序等，这就造成了文件上传漏洞。

## 漏洞成因

文件上传漏洞得成因，一方面服务器配置不当会导致任意文件上传；另一方面，Web应用开放了文件上传功能，并且对上传的文件没有进行足够的限制；再者就是，程序开发部署时候，没有考虑到系统特性和验证和过滤不严格而导致限制被绕过，上传任意文件。

## 漏洞危害

上传漏洞最直接的威胁就是上传任意文件，包括恶意脚本、程序等。如果Web服务器所保存上传文件的可写目录具有执行权限，那么就可以直接上传后门文件，导致网站沦陷。如果攻击者通过其他漏洞进行提权操作，拿到系统管理权限，那么直接导致服务器沦陷。同服务器下的其他网站无一幸免，均会被攻击者控制。

通过上传漏洞获得的网站后门，就是WebShell.

### WebShell

在计算机科学中，Shell俗称壳（用来区别于“核”），是指“为使用者提供操作界面”的软件（命令解释器）。类似于windows系统给的cmd.exe或者linux下bash等，虽然这些系统上的命令解释器不止一种。

WebShell是一个网站的后门，也是一个命令解释器，不过是以Web方式（HTTP协议）通信（传递命令消息），继承了Web用户的权限。WebShell本质上是在服务器端可运行的脚本软件，后缀名为.php/.asp/.aspx/.jsp等，也就是说WebShell接收来自于Web用户的命令，然后在服务器端执行。

- 大马

WebShell也可以是大马，也是网站木马。有一类WebShell之所以叫大马，是因为与小马（一句话木马）区分开，并且代码比较大，但是功能比较丰富。同样，大马有很多种脚本格式，其功能基本相同，每个团队都有自己的定制大马。以下是一个简单的例子，输入密码，密码一般直接写在木马文件中。

在大马中我们可以进行文件管理，执行系统命令等，还有一些其他定制功能。这是asp的大马。

- 小马

小马就是一句话木马，因为其代码量比较小，就是一句简单的代码，以下是各个脚本的一句话

ASP：
<%eval request('cmd')%>
ASP.NET：
<%@ Page Language="Jscript"%>
<%eval(Request.Itml["cmd"],"unsafe");%>
PHP:
<?php @eval($_REQUEST['cmd']);?>

JSP和jspx的一句话木马比较复杂一些

一句话木马短小精悍，功能强大，但是需要配合中国菜刀或者中国蚁剑客户端使用，中国菜刀是一句话木马的管理器，也是命令操作接口。中国菜刀在连接一句话木马的时候需要填写密码（实际上就是变量名）。例如，我们上传一个php的一句话木马，密码就是[cmd]。

### 中国菜刀与一句话木马配合实现了三大基本功能，如下

@ 文件管理

在中国菜刀页面继承Web用户权限可以实现文件管理，包括文件查看、上传、下载、修改、删除甚至运行exe程序等。

@ 虚拟终端

在中国菜刀下可以获得类似于cmd和bash的命令行接口，可以执行相关命令

@ 数据库管理

我们可以使用中国菜刀进行数据库管理，此时需要知道连接数据库的账密。以MYSQL为例子，填写配置，如下。
<T>MYSQL</T>        //数据库类型
<H>localhost</H>    //数据库地址
<U>root</U>         //数据库用户
<P></P>             //数据库的密码，密码为空就不写
<L>utf8</L>         //编码

- GetShell

GetShell，顾名思义，就是获取web的过程和结果。当然任意文件上传是GetShell的主要方式，但并不是唯一途径。

## 文件上传漏利用的条件

- 一定的条件

1. Web服务器要开启文件上传功能，并且上传api（接口）对外“开放”（Web用户可以访问）；
2. Web用户对目标目录具有可写权限，甚至具有执行权限，一般情况下，Web目录都有执行权限。
3. 要想完美利用文件上传漏洞，就是上传的文件可以执行，也就是Web容器可以解析我们上传的脚本，无论脚本以什么样的形式存在。
4. 无视以上条件的情况就是服务器配置不当，开启了PUT方法。

## 防御、绕过、利用

文件上传的防御、文件上传的防御绕过还有利用，总是分不开的。为什么这么防？为什么这么攻击（防御绕过）？总是相互纠缠在一起的两个问题，攻防交替。所以，下文也是以这种方式讨论文件上传的问题。

- 黑白名单策略

黑白名单是最常用的安全策略之一。在计算机安全中，黑白名单类似于一个列表。列表中写了一些条件或规则，如果“客体”在黑名单中，一律“禁止”，如果“客体”在白名单中，一律“允许”。类似于手机号码的黑白名单。

如，Chrome浏览器的黑白名单。

政策                                   说明
URLBlacklist                         禁止用户访问您已阻止的网址。不过，用户可以访问黑名单之外的所有网址。
                                     不设置此政策：用户可以自由访问所有网址。

URLWhitelist                         将此政策与URLBlacklist政策搭配使用，可将特定网址设为黑名单的例外网址并允许用户使用。
                                     白名单的优先级高于黑名单。您至少要在黑名单中添加一个条目，才能正常使用此政策。
                                     不设置此政策：网址黑名单将没有例外网址。

华为收集安装软件黑白名单策略

模式                                  说明
白名单模式，检查只能安装的软件          只允许终端主机安装软件白名单中的软件，安装其他软件则属于违规行为
                                     对于白名单中的软件，该软件属于必须安装类软件，而终端主机未安装该软件，则属于违规行为
                                     对于白名单中的软件，该软件不属于必须安装类软件，而终端主机未安装该软件，则不属于违规行为

白名单+黑名单模式，检查必须安装的软件和禁止安装的软件
                                     如果终端主机未安装白名单中的任意一款软件，则属于违规行为
                                     如果终端主机已经安装黑名单中的任意一款软件，则属于违规行为
                                     如果终端主机已经安装白名单中的所有软件，并且没有安装黑名单中的任意一款软件，则不属于违规行为。


## PUT方法上传文件

HTTP请求方法之一，允许向服务器直接写入文件

## 前端限制与绕过

有些Web应用的文件上传功能，仅在前端用JS脚本做检测，如检测文件后缀名等。upload-labs第一关，以下是经典的代码

<script type="text/javascript">
  function checkFile() {
      var file = document.getElementsByName('upload_file')[0].value;
      if(file == null || file == "") {
          alert("请选择要上传的文件！");
          return false;
      }
      //定义允许上传的文件类型
      var allow_ext = ".jpg|.png|.gif";
      //提取上传文件的类型
      var ext_name = file.substring(file.lastIndexOf("."));
      //判断上传文件类型是否允许上传
      if (allow_ext.indexOf(ext_name) == -1) {
          var errMsg = "该文件不允许上传，请上传" + allow_ext + "类型的文件，当前文件类型为：" + ext_name;
          alert(errMsg);
          return false;

      }
  }