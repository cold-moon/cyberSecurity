# 文件上传&解析漏洞

# 文件解析漏洞

解析漏洞主要说的是一些特殊文件被iis、apache、nginx在某种情况下解释成脚本文件格式的漏洞

## IIS 5.x/6.0解析漏洞

IIS 6.0解析利用方法有两种
1. 目录解析
/xx.asp/xx.jpg

在网站下建立文件夹的名字为.asp、.asa的文件夹，其目录内的任何扩展名的文件都被IIS当作asp文件夹来解析并执行

例如创建目录cracer.asp，那么
/cracer.asp/1.jpg
将被当作asp文件来执行。假设还可以控制上传文件夹路径，就可以不管你上传后的图片改不改名都能拿shell了

2. 文件解析

cracer.asp;.jpg

第二种，在IIS6.0下，分号后面的不被解析，也就是说cracer.asp;,jpg会被服务器看成是wooyun.asp还有IIS6.0默认的可执行文件除了asp还包括这三种
/cracer.asa
/cracer.cer
/cracer.cdx

## Apache解析漏洞

Apache是从右到左开始判断解析，如果为不可识别解析，就再往左判断
比如cracer.php.owf.rar ".owf"和".rar"这两种后缀是apache不可识别解析，apache就会把cracer.php.owf.rar解析成php
如何判断是不是合法的后缀名就是这个漏洞的利用关键，测试时可以尝试上传一个cracer.php.rara.jpg.png...（把你知道的常见后缀都写上...）去测试是否是合法后缀
任意不识别的后缀，逐级向上识别

## IIS 7.0/IIS 7.5/Nginx < 8.03畸形解析漏洞

Nginx解析漏洞这个伟大的漏洞是我国安全组织80sec发现的
在默认Fast-CGI开启状况下，可以上传一个名字为cracer,jpg，内容为
<?PHP fputs(fopen('shell.php','w'),'<?php eval($_POST[cmd])?>');?>
的文件，然后访问cracer.jpg/.php，在这个目录下就会生成一句话木马 shell.php

www.xxx.com/logo.gif/*.php触发漏洞（有漏洞会把前面文件当作php执行）
X。asp00jieduan%jpg
a.aspx.a;a.aspx.jpg..jpg  第二种解析漏洞
或者直接上传xx.asp

## Nginx <8.03 空字节代码执行漏洞

影响版：0.5.，0.6。，0.7 《= 0.7.65，0.8 《= 0.8.37

Nginx在图片中嵌入PHP代码然后通过访问
XXX。jpg%00.php
来执行其中的代码

## htaccess文件解析

如果在Apache中.htaccess可被执行，且可被上传，那可以尝试在.htaccess中写入：
<FilesMatch "shell.jpg">SetHandler application/x-httpd-php</FilesMatch>

然后再上传shell.jpg的木马，这样shell.jpg就可解析为php文件

# 上传本地验证绕过

## 上传检测流程概述

通常一个文件以HTTP协议进行上传时，将以POST请求发送至web服务器web服务器接收到请求后并同意后，用户与web服务器将建立连接，并传输data

## 服务器命名规则

第一种类型：上传文件名和服务器命名一致
第二种类型：上传文件名和服务器命名不一致（随机，时间日期命名等）

## 常见的上传检测方式

1. 客户端javascript检测（通常为检测文件扩展名）
2. 服务端MIME类型检测（检测Content-Type内容）
3. 服务端目录路径检测（检测跟path参数相关的内容）
4. 服务端文件扩展名检测（检测跟文件extension相关的内容）
5. 服务端文件内容检测（检测内容是否合法后含有恶意代码）

